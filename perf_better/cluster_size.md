# 基于网络和磁盘消息吞吐量预估集群规模

为Kafka集群选择正确的硬件要很多方面。最准确的方式是在自己的硬件上模拟期望的压力。你可以使用Kafka自带的压力生成工具，kafka-producer-perf-test 以及 kafka-consumer-perf-test.

#### 基于磁盘空间量
如果你希望在不模拟的情况下来决定集群大小，比较简单的规则是基于磁盘空间量来评估。这可以用估算的数据速率 * 数据的保留时间。

#### 基于网络和磁盘吞吐
比这个稍微复杂的估计方法可以基于网络和磁盘吞吐需求。为了进行评估，我们假设有以下特征的用例：

1. W - 数据写入的速率 MB/sec
2. R - Replication factor
3. C - 消费者组的数量, 这是每个写入的读取者数量

Kafka大概受到磁盘和网络吞吐量的影响。

预期的写入量是 `W * R`，因为副本也会写入。

数据既被副本拉取，也会被消费者拉取。

因为只有master有读和写，所以副本的读取量是 `(R-1) * W`

C个消费者组的读取量为 `C * W`

所以：

1. 写入 `W * R`
2. 读取 `(R+C-1) * W`

但是在实际情况下，读取可能会被缓存，没有真正的磁盘I/O。我们可以相当容易地模拟缓存的影响。

如果机器有M MB内存，对于W MB/second的写入，允许`M/(W * R)`秒的写入被缓存。所以在50MB/s的写入下，32G内存的服务器可以使用缓存来服务最后10分钟`（32*1024/50=655s）`的数据。

消费者可能由于某些原因遇到缓存失效的情况，比如较慢的消费者/重启的宕机的服务需要追赶上。

有个简单的方式来模拟这种情况：假设一些延迟的读取者，数量为L。

非常悲观的假设是`L = R + C - 1`，也就是所有的消费者一直在滞后。
比较现实的假设是在任何给定的时间内，滞后的消费者不超过2个。

基于这种假设，我们可以计算集群的I/O需求：

磁盘吞吐量 读+写： `W * （R + L）`
网络读取吞吐：`（R + C - 1）* W`
网络写入吞吐：`W * R`

单个服务器提供一个给定的磁盘吞吐和网络吞吐。例如，如果网卡是1Gigabit的全双工网卡，那它可以分别提供125MB/s的写入和读取。同时6个7200转的SATA可能大约给出300MB/s的读+写。

一旦我们知道了总体的需求，以及单机器的能力，可以通过除得到所需的机器总数。这就提供了一个以最大容量运行的机器数量。假设没有网络协议的开销，数据负载也十分完美的情况下。因为有这些开销，你可能需要至少理想中容量的2倍，来确保有足够的容量。

#### 例子

假设有以下基准测试的数据：

1. 网卡9.41 Gbits/sec => 9410Mbit/sec => (9410/8) = 1176MB/s
2. 磁盘顺序写 written, MiB/s: 794.79，一块盘

假如写入是W = 300MB/s，R = 3，C = 1，L = R + C - 1 = 3

1. 磁盘吞吐量 读+写： 300 * 6 = 1800
2. 网络读取吞吐：300 * 3 = 900
3. 网络写入吞吐：300 * 3 = 900

大概需要2 * 2 = 4台
